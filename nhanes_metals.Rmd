---
title: "nhanes_metals"
author: "Nicole Comfort"
date: "12/6/2019"
output: html_document
---

First, check whether you have the necessary packages installed and if not, install them.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

##  install necessary packages

#install.packages("tidyverse")
#install.packages("NHANES") # example NHANES data to play with 
#install.packages("survey") # Used to take into account complex survey designs like NHANES
## Documentation for this package is: https://cran.r-project.org/web/packages/survey/survey.pdf

# install.packages("Hmisc")
# install.packages("foreign")
# install.packages("labelled")
# install.packages("knitr")
# install.packages("kableExtra")

# load libraries
library(tidyverse)
library(NHANES)
library(survey) # This package handles survey weights/designs easily
library(Hmisc) # This is a package (H misc.) for basic desciptive functions.
library(foreign) # This package allows us to open .XPT files
library(labelled)
library(knitr)
library(kableExtra)
library(moments)

```

# Background:  
The National Health and Nutrition Examination Survey (NHANES) is a nationally-representative survey of the general, noninstutionalized US civilian population conducted by the National Center for Health Statistics. NHANES is a multi-stage sample completed in two-year cycles. Participants are chosen to represent the entire general U.S., but certain age groups and racial/ethnic groups are intentionally oversampled to ensure adequate power to analyze these populations.

Participants undergo thorough examination including demographic questionnaire, a 24-hr dietary recall, a clinical examination, and a laboratory examination. All NHANES protocols were approved by the National Center for Health Statistics institutional review board, and all participants gave written informed consent.

For more information on NHANES, view the Centers for Disease Control and Prevention (CDC) website: https://www.cdc.gov/nchs/nhanes/index.htm

### Note:
NHANES does not measure every environmental chemical in every participant. For some environmental chemicals, these measurements are only done on a subset of participant samples and there are special sub-weights that need to be used for analyzing these chemicals. 

Here, we will explore the *unadjusted* levels of lead, cadmium, mercury, and manganese measured in blood of males versus females to examine if there is a sex difference in body burden of these chemicals.

We will conduct this analysis in one two-year survey cycle (2015/2016), *since combining weights across survey cycles is very complex.* See http://www.cdc.gov/nchs/tutorials/NHANES/SurveyDesign/Weighting/intro.htm for more information. 

# Download NHANES Data and Clean

The data files must first be downloaded. They can be found and downloaded at the NHANES website: https://wwwn.cdc.gov/nchs/nhanes/continuousnhanes/default.aspx?BeginYear=2015 

```{r NHANES data}

# Load data

# Demographic files for 2015-2016
demo1516 <- read.xport("DEMO_I.XPT") %>% 
  arrange(SEQN)
## Data documentation file: https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/DEMO_I.htm

# Laboratory blood Pb, Cd, Hg, Mn files for 2015-2016
cd1516 <- read.xport("PBCD_I.XPT") %>% 
  arrange(SEQN)
## Data documentation file: https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/PBCD_I.htm
### Eligible Sample: All examined participants aged 1-11 years old, and a one-half sample from participants aged 12 years and older were eligible. 

# Inorganic, Ethyl, Methyl Mercury for 2015-2016
hg1516 <- read.xport("IHGEM_I.XPT") %>% 
  arrange(SEQN)
## Data documentation file: https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/IHGEM_I.htm
### Eligible Sample: All examined participants aged 1-11 years old, and a one-half sample from participants aged 12 years and older were eligible.

# Total Mercury in Urine for 2015-2016
uhg1516 <- read.xport("UHG_I.XPT") %>% 
  arrange(SEQN)
## Data documentation file: https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/UHG_I.htm
### Eligible Sample: All examined participants aged 3 to 5 years were eligible and participants aged 6 years and older from a one-third subsample were eligible.
#### Note that this is different weighting scheme than for blood metals

## Arsenic
# Speciated urinary arsenics for 2015-2016
uas_sp <- read.xport("UAS_I.XPT") %>% 
  arrange(SEQN)
## Data documentation file: https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/UAS_I.htm
### Eligible Sample: All examined participants aged 3 to 5 years were eligible and participants aged 6 years and older from a one-third subsample were eligible.

# Total urinary arsenic for 2015-2016
uas_t <- read.xport("UTAS_I.XPT") %>% 
  arrange(SEQN)
## Data documentation file: https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/UTAS_I.htm
### Eligible Sample: All examined participants aged 3 to 5 years were eligible and participants aged 6 years and older from a one-third subsample were eligible.

# creatinine for 2015-2016 (for adjustment of urinary arsenic and urinary mercury)
creatinine <- read.xport("ALB_CR_I.XPT") %>% 
  arrange(SEQN)
## Data documentation file: https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/ALB_CR_I.htm
### Eligible Sample: Examined participants aged 3 years and older were eligible.

```

## Blood Metals: Subset Data Cleaning and Evaluation

```{r create blood metal dataframe}

# Blood metal dataframe 

# Merge data to create one dataframe per year; then keep only the necessary variables:
nh1516 <- merge(demo1516, cd1516, by = "SEQN", all = TRUE)
nh1516 <- merge(nh1516, hg1516, by = c("SEQN", "WTSH2YR"), all = TRUE)
# later, exclude those who have WTSH2YR as "NA"

# double check that there aren't repeat columns renamed [col_name].x or [col_name].y

## Here is a list of variables we will need for our analysis:
# SEQN, SDDSRVYR, RIAGENDR, RIDAGEYR, RIDRETH1, WTMEC2YR, SDMVPSU, SDMVSTRA, WTSH2YR
# LBXBPB (blood lead), LBXBCD (blood cadmium),
# LBXBSE (blood selenium), LBXBMN (blood manganese)
# LBXTHG (blood total mercury), LBXIHG (blood inorganic mercury),
# LBXBGE (ethyl mercury), LBXBGM (methyl mercury)

# Retain only necessary variables:
nh1516_sub <-
  nh1516 %>%
  select(SEQN, SDDSRVYR, # unique identifier and survey year 
         RIAGENDR, RIDAGEYR, RIDRETH1, # gender, age, race/ethnicity
         WTMEC2YR, SDMVPSU, SDMVSTRA, WTSH2YR, # weighting info
         LBXBPB, LBXBCD, LBXBMN, LBXTHG, LBXIHG, LBXBGE, LBXBGM) %>% # metals (exclude selenium for now)
  janitor::clean_names() %>% 
  mutate(lbxohg = lbxthg - lbxihg) %>% # create new variable for organic mercury (total Hg - inorganic Hg)
  rename(sex = riagendr,
         age = ridageyr,
         race = ridreth1) %>% 
  set_value_labels(                     # Label variable values
    sex = c("Male" = 1, "Female" = 2), 
    race = c("Mexican American" = 1,
             "Other Hispanic" = 2,
             "NH White" = 3,
             "NH Black" = 4,
             "Other including multi" = 5)) %>% 
  mutate_if(is.labelled, to_factor)  # Treat any labelled variables (e.g. sex) as factors


# Note to self: why are some organic mercury values (the variable I created) negative?? 
# later, plot mercury broken down as organic and inorganic, but also try breaking down organic to ethyl and methyl
# or Annie's recommendation was just to plot total and methyl?  
```

Blood metals are measured in all participants aged 1-11 years old, and additionally in only a one-half subsample of participants 12 years and older.

Let's find how many people are missing the weight value, indicating that they did not have their blood metals measured: 

```{r remove NAs and 0 weights}

# assess missingness of weights variable to see how many were eligible
# those that were eligible, i.e. all participants 1-11 and half of participants aged 12 and older will have a wtsh2yr value that is not equal to 0 
nh1516_sub %>% 
  count(is.na(wtsh2yr))

# The appropriate sample weights are provided in the variable WTSH2YR in this data file for all participants and should be used when analyzing these data.

# The analytes included in this dataset were measured for all examined participants aged 1-11 years, and in a one-half subsample of participants 12 years and older. For participants aged 1-11 years their WTSH2YR are equivalent to their MEC exam sample weights. These 1-11 years old participants have completed at least one physical exam component in the MEC; therefore, they all have an exam sample weight larger than “0,” regardless of their lab test results.

# For participants 12 years and older, special sample weights were created for the subsample. These special weights accounted for the additional probability of selection into the subsample, as well as the additional nonresponse to these lab tests. Therefore, if a participant 12 years and older was selected as part of the one-half subsample, but did not provide a blood specimen, he/she would have the sample weight value assigned as “0” in his/her record. 

# so would including someone with weight 0 make a difference?? Can I just exclude them?? 

# drop rows missing the weight variable to arrive at the eligible subset
nh1516_sub <- 
  nh1516_sub %>%  
  drop_na(wtsh2yr) %>%   
  filter(wtsh2yr != 0)  
   
```

Of the 9,971 participants surveyed in 2015-2016, `r {nrow(nh1516_sub)}` were eligible to have blood metals measured.

### Blood Metals: Missing Data

Let's further evaluate missing data. Of those eligible, how many did not have blood metals measured? 

```{r evaluate missing metal data}

# of those eligible, how many are missing values of our metals of interest (Pb, Cd, Hg, Mn)? 

## NOTE: According to the NHANES website, as a general rule, if 10% or less of your data for a variable are missing from your analytic dataset, it is usually acceptable to continue your analysis without further evaluation or adjustment
### However, if > 10% of the data for a variable are missing, you may need to determine whether the missing values are distributed equally across socio-demographic characteristics, and decide whether further imputation of missing values or use of adjusted weights are necessary 

# for Pb
nh1516_sub %>%
  count(is.na(lbxbpb))
# 609, or 10.88% still missing data.... seems extremely high, should probably check to see whether missingness is at random or not 

# for Cd
nh1516_sub %>%
  count(is.na(lbxbcd))
# 10.88% missing data
 
# for total Hg 
nh1516_sub %>%
  count(is.na(lbxthg)) 
# 10.88% missing data  

# for Mn 
nh1516_sub %>%
  count(is.na(lbxbmn))
# 10.89% missing data  

# drop rows with missing values
nh1516_sub <- 
  nh1516_sub %>% 
  drop_na(lbxbpb, lbxbmn)
 
```

From our eligible subset, about 11% had missing values for blood metals Pb, Cd, Mn, and total Hg. Thus, after removing participants with missing values, we are left with `r {nrow(nh1516_sub)}` for analysis.

## Inorganic, Ethyl, and Methyl Mercury: Subset Data Cleaning and Evaluation

### Inorganic, Ethyl, and Methyl Mercury: Missing Data

```{r create separate dataset for speciated mercury, include=FALSE}
# assess missingness 

# for ethyl Hg
nh1516_sub %>%
  count(is.na(lbxbge))
# 52 participants missing values.

# for methyl Hg
nh1516_sub %>%
  count(is.na(lbxbgm))
# 50 participants missing values.

# for inorganic Hg
nh1516_sub %>%
  count(is.na(lbxihg))
# 50 participants missing values.

# create separate data subset for speciated mercury including only the complete cases
hg1516_sub <-  
  nh1516_sub %>%
  drop_na(lbxbge) %>%  
  select(-lbxbpb, -lbxbcd, -lbxbmn)

```

Because there were additional participants missing values of mercury (inorganic, ethyl, and methyl), we created a separate dataset, `hg1516`, for blood mercury. After retaining only complete cases, we are left with `r {nrow(hg1516_sub)}` participants for mercury analysis. 

## Urinary Mercury: Subset Data Cleaning and Evaluation

*As we can see, there was much higher concentrations of organic Hg than inorganic Hg for Hg measured in blood (double-check)*

The concentration of total Hg in urine is a biomarker of exposure primarily to elemental and inorganic Hg, although some Hg in urine comes from de-methylation of methyl Hg in blood (Abe et al., 1995). Thus, examining total Hg in urine better reflects exposure to inorganic Hg.

NHANES 2015/2016 collected information on Hg in urine. We will analyze this data from NHANES 2015/2016 as well.

```{r create urinary mercury dataframe, include=FALSE}

# urinary Hg dataframe

# Merge data to create one dataframe per year; then keep only the necessary variables: 
uhg1516 <- merge(demo1516, uhg1516, by = "SEQN", all = TRUE) 
uhg1516 <- merge(uhg1516, creatinine, by = "SEQN", all = TRUE) 
# later, exclude those who have WTSA2YR as "NA"

## Here is a list of variables we will need for our analysis:
# SEQN, SDDSRVYR, RIAGENDR, RIDAGEYR, RIDRETH1, WTMEC2YR, SDMVPSU, SDMVSTRA
# WTSA2YR (NEW WEIGHTING VARIABLE)
# URXUHG (urine mercury, ng/mL), URXUCR (creatinine, mg/dL)

# Data Cleaning to Create Urinary Hg Data Subset: 
uhg1516_sub <-
  uhg1516 %>%
  select(SEQN, SDDSRVYR, # unique identifier and survey year 
         RIAGENDR, RIDAGEYR, RIDRETH1, # gender, age, race/ethnicity
         WTMEC2YR, SDMVPSU, SDMVSTRA, WTSA2YR, # weighting info
         URXUHG, URXUCR) %>% # metals (exclude selenium for now)
  janitor::clean_names() %>% 
  mutate(cr_ng_ml = urxucr*10000) %>% # convert creatining from mg/dL to ng/mL
  mutate(urxuhg_adj = urxuhg/cr_ng_ml) %>% # urine hg adjusted for creatinine 
  rename(sex = riagendr,
         age = ridageyr,
         race = ridreth1) %>% 
  set_value_labels(                     # Label variable values
    sex = c("Male" = 1, "Female" = 2), 
    race = c("Mexican American" = 1,
             "Other Hispanic" = 2,
             "NH White" = 3,
             "NH Black" = 4,
             "Other including multi" = 5)) %>% 
  mutate_if(is.labelled, to_factor)  # Treat any labelled variables (e.g. sex) as factors
 
```

Urinary mercury is eligible to be measured in all participants aged 3 to 5 years and in a one-third subsample of participants aged 6 years and older.

### Urinary Mercury: Missing Data

Let's find how many people are missing the weighting value, indicating that they did not have their urinary mercury measured: 

```{r remove NAs and 0 weights for urinary Hg, include=FALSE}
 
# assess missingness of weights variable to see how many were eligible
# those that were eligible, i.e. all participants 3-5 and one-third of participants aged 6 and older will have a wtsa2yr value that is not equal to 0 
uhg1516_sub %>% 
  count(is.na(wtsa2yr))
# there are more missing than for blood metals, which makes sense because we sampled only one third of the eligible participants rather than one-half and also are missing data for children < 3 years old

# drop rows missing the weight variable to arrive at the eligible subset
uhg1516_sub <-
  uhg1516_sub %>% 
  drop_na(wtsa2yr) %>%  
  filter(wtsa2yr != 0)  

```

Of the 9,971 participants surveyed in 2015-2016, `r {nrow(uhg1516_sub)}` were eligible to have urine mercury measured.

```{r drop missing mercury and creatinine, include=FALSE}

# assess missing 
uhg1516_sub %>%
  count(is.na(urxuhg)) 

uhg1516_sub %>%
  count(is.na(urxucr))

uhg1516_sub %>%
  count(is.na(urxuhg_adj))

# drop rows with missing Hg and creatinine values
uhg1516_sub <-
  uhg1516_sub %>% 
  drop_na(urxuhg, urxucr)

```

Furthermore, out of those eligible, about 4.6% were missing values for urinary mercury. After dropping those with values missing for urinary mercury and/or creatinine (needed for adjustment), we have `r {nrow(uhg1516_sub)}` participants remaining for analysis. 

## Urinary Arsenic: Subset Data Cleaning and Evaluation

```{r create urinary arsenic dataframe}

# Urinary arsenic dataframe

# Merge data to create one dataframe per year; then keep only the necessary variables:
uas1516 <- merge(demo1516, creatinine, by = "SEQN", all = TRUE)
uas1516 <- merge(uas1516, uas_sp, by = "SEQN", all = TRUE)
uas1516 <- merge(uas1516, uas_t, by = "SEQN", all = TRUE)

uas1516 <- uas1516 %>% 
  mutate(WTSA2YR = WTSA2YR.x) 

# later, exclude those who have WTSA2YR as "NA"

## Here is a list of variables we will need for our analysis:
# SEQN, SDDSRVYR, RIAGENDR, RIDAGEYR, RIDRETH1, WTMEC2YR, SDMVPSU, SDMVSTRA
# WTSA2YR (NEW WEIGHTING VARIABLE)
# URXUCR (creatinine, mg/dL)
# URXUAS3, URXUAS5, URXUAB, URXUAC, URXUDMA, URXUMMA (all in ug/L)
# URXUAS (total urine arsenic, ug/L)

# Data Cleaning to Create Urinary Hg Data Subset: 
uas1516_sub <-
  uas1516 %>%
  select(SEQN, SDDSRVYR, 
         RIAGENDR, RIDAGEYR, RIDRETH1, 
         WTMEC2YR, SDMVPSU, SDMVSTRA, WTSA2YR, 
         URXUCR, URXUAS3, URXUAS5, URXUAB, URXUAC, URXUDMA, URXUMMA, URXUAS) %>%
  janitor::clean_names() %>% 
  mutate(urxucr = urxucr*10000) %>% # convert creatinine from mg/dL to ug/L 
  mutate(urxuas3 = urxuas3/urxucr, # did I adjust correctly?? 
         urxuas5 = urxuas5/urxucr,
         urxuab = urxuab/urxucr,
         urxuac = urxuac/urxucr,
         urxudma = urxudma/urxucr,
         urxumma = urxumma/urxucr,
         urxuas = urxuas/urxucr) %>% # urine arsenic adjusted for creatinine 
  rename(sex = riagendr,
         age = ridageyr,
         race = ridreth1) %>% 
  set_value_labels(                     # Label variable values
    sex = c("Male" = 1, "Female" = 2), 
    race = c("Mexican American" = 1,
             "Other Hispanic" = 2,
             "NH White" = 3,
             "NH Black" = 4,
             "Other including multi" = 5)) %>% 
  mutate_if(is.labelled, to_factor)  # Treat any labelled variables (e.g. sex) as factors
 

```

Urinary arsenic (total and speciated) is eligible to be measured in all participants aged 3 to 5 years and in a one-third subsample of participants aged 6 years and older.

### Urinary Arsenic: Missing Data

Let's find how many people are missing the weighting value, indicating that they did not have their urinary mercury measured: 

```{r remove NAs and 0 weights for urinary arsenic, include=FALSE}
 
# assess missingness of weights variable to see how many were eligible
# those that were eligible, i.e. all participants 3-5 and one-third of participants aged 6 and older will have a wtsa2yr value that is not equal to 0 
uas1516_sub %>% 
  count(is.na(wtsa2yr))

# drop rows missing the weight variable to arrive at the eligible subset
uas1516_sub <-
  uas1516_sub %>% 
  drop_na(wtsa2yr) %>%  
  filter(wtsa2yr != 0)  

```

Of the 9,971 participants surveyed in 2015-2016, `r {nrow(uas1516_sub)}` were eligible to have urine arsenic measured.

```{r drop missing urinary arsenic and DMA, include=FALSE}
 
# assess missing 
uas1516_sub %>%
  count(is.na(urxuas))

uas1516_sub %>% 
  count(is.na(urxudma))

uhg1516_sub %>%
  count(is.na(urxucr))

# drop rows with missing total arsenic and creatinine values
uas1516_sub <-
  uas1516_sub %>% 
  drop_na(urxuas, urxucr)

# Note, after this, there is just one person missing a DMA value, let's just exclude them as well 
uas1516_sub <-
  uas1516_sub %>% 
  drop_na(urxudma)

```

Furthermore, out of those eligible, 5.4% were missing values for total arsenic and DMA. After dropping those with values missing for urinary arsenic and/or creatinine (needed for adjustment), we have `r {nrow(uas1516_sub)}` participants remaining for analysis. 

### Total N's

There were `r {nrow(nh1516)}` participants surveyed in the NHANES 2015-2016 cycle.

In our data subsets, there are:

* `r {nrow(nh1516_sub)}` participants with Pb, Cd, Mn, and total Hg measured in blood,

* `r {nrow(hg1516_sub)}` participants with inorganic, ethyl, and methyl Hg measured in blood,

* `r {nrow(uhg1516_sub)}` participants Hg measured in urine,

* `r {nrow(uas1516_sub)}` participants with total and speciated arsenic measured in urine

for our analyses.

# Sample Weighting

Note that NHANES is designed to sample larger numbers of certain subgroups of particular public health interest (e.g. low income Americans, African Americans). Oversampling is done to increase the reliability and precision of estimates of health status indicators for these population subgroups. To account for this sampling design and these design features in our analysis, it is critical that we apply sample weights.

Continue data cleaning by applying appropriate sample weights, which will allow us to calculate unbiased estimates.

## Survey Weights

```{r survey weighting, echo=FALSE}

# Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
# Primary Sampling Units (PSU) 
 
# Here we use "svydesign" to assign the weights. We will use this new survey design variable when running our analyses
# Blood Pb, Cd, Mn
blood.svy <- svydesign(ids = ~sdmvpsu, # cluster IDs
                        strata = ~sdmvstra, # strata IDs
                        weights = ~wtsh2yr, # individual weights, subsample descriptions and weights are found in the specific datafiles downloaded from NHANES website
                        nest = TRUE,
                        data = nh1516_sub) # call the dataframe 

summary(blood.svy) 

# Blood Hg
########################################
blood.hg.svy <- svydesign(ids = ~sdmvpsu, 
                        strata = ~sdmvstra, 
                        weights = ~wtsh2yr, 
                        nest = TRUE,
                        data = hg1516_sub) # call the dataframe 

summary(blood.hg.svy) 

# Urinary Hg
########################################
urine.hg.svy <- svydesign(ids = ~sdmvpsu, 
                        strata = ~sdmvstra, 
                        weights = ~wtsa2yr, 
                        nest = TRUE,
                        data = uhg1516_sub)  

summary(urine.hg.svy) 

# urinary arsenic
########################################
arsenic.svy <- svydesign(ids = ~sdmvpsu,
                        strata = ~sdmvstra, 
                        weights = ~wtsa2yr, 
                        nest = TRUE,
                        data = uas1516_sub) 

summary(arsenic.svy) 

# account for non-response (since there are many sub-components of NHANES, incl. interview, labs, exposure data)
# thus, sub-samples have different weights because not all participants are invited to participate in all sub-components

## If you want to combine weights across sub-samples within a survey cycle or across survey cycles, this is even more complex
## Advice: don’t do it unless you understand what you are doing.  

```

## Survey-Weighted Data Distributions

### Data Distribution: Blood Metals

```{r check distributions and describe impact of influential outliers blood metal}

# check the distribution and normality of the data and identify outliers for continuous variables
# "svyhist" creates histograms accounting for survey weights

## Lead
svyhist(~lbxbpb,
        blood.svy,
        main = "Survey weighted average blood Pb", col = "blue")
# right-skewed

# Pb log transformed
svyhist(~log(lbxbpb),
        blood.svy,
        main =  "Survey weighted log(average blood Pb)", col = "blue")
# log transformed data now normal

## Cadmium
svyhist(~lbxbcd,
        blood.svy,
        main = "Survey weighted average blood Cd", col = "red")
# right-skewed

# Cd log transformed
svyhist(~log(lbxbcd),
        blood.svy,
        main = "Survey weighted log(average blood Cd)", col = "red")

## log-transformed Cd still not quite normal??? 

## Total Mercury
svyhist(~lbxthg,
        blood.svy,
        main = "Survey weighted average blood total Hg", col = "cyan")
# right-skewed

# tHg log transformed
svyhist(~log(lbxthg),
        blood.svy,
        main = "Survey weighted log(average blood total Hg)", col = "cyan")
## log-transformed tHg still not quite normal??? 
 
## Manganese 
svyhist(~lbxbmn,
        blood.svy, 
        main = "Survey weighted average blood Mn", col = "yellow")
# right-skewed

# Mn log transformed 
svyhist(~log(lbxbmn),
        blood.svy,
        main = "Survey weighted log(average blood Mn)", col = "yellow")
# log-transformed now normal

## Do I have to test these distributions for normality statistically?? 
```

```{r blood metals skewness}
# but this doesn't take into account the weighting....? or is the weighting only needed for statistical tests but not for assessments of normality? 

# Pb skewness/kurtosis
skewness(nh1516_sub$lbxbpb)
kurtosis(nh1516_sub$lbxbpb)

# Pb qqplot
qqnorm(nh1516_sub$lbxbpb)
qqline(nh1516_sub$lbxbpb)

# log transformed Pb skewness/kurtosis
skewness(log(nh1516_sub$lbxbpb))
kurtosis(log(nh1516_sub$lbxbpb))

# log transformed qqplot, Pb
qqnorm(log(nh1516_sub$lbxbpb))
qqline(log(nh1516_sub$lbxbpb))

# Cd skewness/kurtosis
skewness(nh1516_sub$lbxbcd)
kurtosis(nh1516_sub$lbxbcd)

# Cd qqplot
qqnorm(nh1516_sub$lbxbcd)
qqline(nh1516_sub$lbxbcd)

# log transformed Cd skewness/kurtosis
skewness(log(nh1516_sub$lbxbcd))
kurtosis(log(nh1516_sub$lbxbcd))

# log transformed qqplot, Cd
qqnorm(log(nh1516_sub$lbxbcd))
qqline(log(nh1516_sub$lbxbcd))

# Mn skewness/kurtosis
skewness(nh1516_sub$lbxbmn)
kurtosis(nh1516_sub$lbxbmn)

# Mn qqplot
qqnorm(nh1516_sub$lbxbmn)
qqline(nh1516_sub$lbxbmn)

# log transformed Mn skewness/kurtosis
skewness(log(nh1516_sub$lbxbmn))
kurtosis(log(nh1516_sub$lbxbmn))

# log transformed qqplot, Mn
qqnorm(log(nh1516_sub$lbxbmn))
qqline(log(nh1516_sub$lbxbmn))

```


### Data Distribution: Inorganic, Ethyl, Methyl Mercury

```{r check distributions and describe impact of influential outliers speciated blood Hg}

# check the distribution and normality of the data and identify outliers for continuous variables
# "svyhist" creates histograms accounting for survey weights 
 
## Inorganic Hg
svyhist(~lbxihg,
        blood.hg.svy, 
        main = "Survey weighted average blood inorganic Hg", col = "yellow")
# right-skewed

# iHg log transformed
svyhist(~log(lbxihg),
        blood.hg.svy,
        main = "Survey weighted log(average blood inorganic Hg)", col = "yellow")
# still not normal...

## Ethyl Hg
svyhist(~lbxbge,
        blood.hg.svy, 
        main = "Survey weighted average blood ethyl Hg", col = "yellow")
# right-skewed

# eHg log transformed
svyhist(~log(lbxbge),
        blood.hg.svy, 
        main = "Survey weighted log(average blood ethyl Hg)", col = "yellow")
# still not normal.... 

## Methyl Hg
svyhist(~lbxbgm,
        blood.hg.svy, 
        main = "Survey weighted average blood MeHg", col = "yellow")
# right-skewed 

# meHg log transformed
svyhist(~log(lbxbgm),
        blood.hg.svy,  
        main = "Survey weighted log(average blood MeHg)", col = "yellow")
# still not quite normal.... 

```

```{r speciated mercury skewness}

# iHg skewness/kurtosis
skewness(hg1516_sub$lbxihg)
kurtosis(hg1516_sub$lbxihg)

# iHg qqplot
qqnorm(hg1516_sub$lbxihg)
qqline(hg1516_sub$lbxihg)

# log transformed iHg skewness/kurtosis
skewness(log(hg1516_sub$lbxihg))
kurtosis(log(hg1516_sub$lbxihg))

# log transformed iHg qqplot
qqnorm(log(hg1516_sub$lbxihg))
qqline(log(hg1516_sub$lbxihg))

####

# ethyl Hg skewness/kurtosis
skewness(hg1516_sub$lbxbge)
kurtosis(hg1516_sub$lbxbge)

# ethyl Hg qqplot
qqnorm(hg1516_sub$lbxbge)
qqline(hg1516_sub$lbxbge)

# log transformed ethyl Hg skewness/kurtosis
skewness(log(hg1516_sub$lbxbge))
kurtosis(log(hg1516_sub$lbxbge))

# log transformed ethyl Hg qqplot
qqnorm(log(hg1516_sub$lbxbge))
qqline(log(hg1516_sub$lbxbge))

###

# methyl Hg skewness/kurtosis
skewness(hg1516_sub$lbxbgm)
kurtosis(hg1516_sub$lbxbgm)

# methyl Hg qqplot
qqnorm(hg1516_sub$lbxbgm)
qqline(hg1516_sub$lbxbgm)

# log transformed methyl Hg skewness/kurtosis
skewness(log(hg1516_sub$lbxbgm))
kurtosis(log(hg1516_sub$lbxbgm))

# log transformed methyl Hg qqplot
qqnorm(log(hg1516_sub$lbxbgm))
qqline(log(hg1516_sub$lbxbgm))

```


### Data Distribution: Urinary Mercury

```{r check distributions and describe impact of influential outliers urinary Hg}

# check the distribution and normality of the data and identify outliers for continuous variables

# adjusted urinary Hg
svyhist(~urxuhg_adj,
        urine.hg.svy, 
        main = "Survey weighted average urinary Hg, creatinine-adjusted", col = "yellow")
# right-skewed

# log-transformed adjusted urinary Hg
svyhist(~log(urxuhg_adj),
        urine.hg.svy, 
        main = "Survey weighted log(average creatinine-adjusted urinary Hg)", col = "yellow")
# normal 

```

```{r urinary mercury skewness}

# urinary Hg, adjusted for creatinine
skewness(uhg1516_sub$urxuhg_adj)
kurtosis(uhg1516_sub$urxuhg_adj)

# Pb qqplot
qqnorm(uhg1516_sub$urxuhg_adj)
qqline(uhg1516_sub$urxuhg_adj)

# log(urinary Hg, adjusted for creatinine)
skewness(log(uhg1516_sub$urxuhg_adj))
kurtosis(log(uhg1516_sub$urxuhg_adj))

# log transformed qqplot, Pb
qqnorm(log(uhg1516_sub$urxuhg_adj))
qqline(log(uhg1516_sub$urxuhg_adj))

# log adjusted looks great! 

```

```{r}

# assess if there are influential / extreme outliers

```


### Data Distribution: Urinary Arsenic

```{r check distributions and describe impact of influential outliers urinary As}

# check the distribution and normality of the data and identify outliers for continuous variables

## Total Arsenic
svyhist(~urxuas, # already adjusted for creatinine in this dataset 
        arsenic.svy,
        main = "Survey weighted average urinary As, creatinine-adjusted", col = "blue")

# log transformed
svyhist(~log(urxuas),
        arsenic.svy,
        main = "Survey weighted log(average urinary As, creatinine-adjusted)", col = "blue")
## looks much more normal 

## DMA
svyhist(~urxudma, # already adjusted for creatinine in this dataset 
        arsenic.svy,
        main = "Survey weighted average urinary DMA, creatinine-adjusted", col = "red")
# right-skewed 

# log transformed
svyhist(~log(urxudma),
        arsenic.svy,
        main = "Survey weighted log(average urinary DMA, creatinine-adjusted)", col = "red")
# normal 

```

```{r urinary arsenic skewness}

# adjusted arsenic
skewness(uas1516_sub$urxuas)
kurtosis(uas1516_sub$urxuas)

qqnorm(uas1516_sub$urxuas)
qqline(uas1516_sub$urxuas)

# log(adjusted arsenic)
skewness(log(uas1516_sub$urxuas))
kurtosis(log(uas1516_sub$urxuas))

qqnorm(log(uas1516_sub$urxuas))
qqline(log(uas1516_sub$urxuas))

# log looks much better! still some extremes at the tails though 

###

# adjusted DMA
skewness(uas1516_sub$urxudma)
kurtosis(uas1516_sub$urxudma)

qqnorm(uas1516_sub$urxudma)
qqline(uas1516_sub$urxudma)

# log(adjusted DMA)
skewness(log(uas1516_sub$urxudma))
kurtosis(log(uas1516_sub$urxudma))

qqnorm(log(uas1516_sub$urxudma))
qqline(log(uas1516_sub$urxudma))

# looks much better! 

```


## Descriptive Statistics

Find the mean levels and SE of Pb, Cd, Hg (inorganic and organic), and Mn in the US population (accounting for survey weights and design). 

```{r example descriptive stats using survey functions, eval=FALSE, include=FALSE}

# useful survey functions: 

## svymean: Computes means and SEs for survey data
svymean(~lbxbpb, # continuous variable(s)
        nhanes.svy) # the ”svydesign” object

# Example, we compute the means of multiple variables:
svymean(~lbxbpb+lbxbcd+lbxthg+lbxihg+lbxohg+lbxbmn, 
        nhanes.svy)

# put results into a table
mean_metals_table <-
  svymean(~lbxbpb+lbxbcd+lbxthg+lbxihg+lbxohg+lbxbmn, nhanes.svy) %>% 
  kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = F) 
# note that lbxbpb is in the units ug/dL whereas the others are in ug/L

##############################################################
## By Sex

## svyby: Survey stats on subsets of data (or, survey stats across levels of factors)
svyby(~lbxbpb+lbxbcd+lbxthg+lbxihg+lbxohg+lbxbmn, # continuous variable
      by = ~sex, # groups
      nhanes.svy, # the ”svydesign” object 
      svymean)  # the function you want %>% 

# put into a table
sex_mean_metals_table <-
  svyby(~lbxbpb+lbxbcd+lbxthg+lbxihg+lbxohg+lbxbmn, # continuous variable
      by = ~sex, # groups
      nhanes.svy, # the ”svydesign” object 
      svymean) %>%  # the function you want %>% 
  kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = F) 

##############################################################

# Other useful functions: 

## svyhist: Survey-weighted histograms
 
## svyquantile: Computes quantiles for survey data (you can choose the quantile values)
svyquantile(~lbxbpb, # continuous variable  
            nhanes.svy, # the ”svydesign” object  
            c(0.10, 0.90), # list of percentiles 
            ci = F)

## svychisq: Contingency table and chi-squared tests for survey data; weighted cross tabulations
 
```

```{r descriptive stats for Pb, Cd, Mn, total Hg}

```

```{r descriptive stats for speciated Hg}

```

```{r descriptive stats for urinary Hg}

```


The following are the estimated means and SEs of blood levels of lead, cadmium, mercury (total, inorganic, and organic), and manganese in the 2015/2016 US population: 

r (print(mean_metals_table))

Broken down by sex: 

r (print(sex_mean_metals_table))

Note that, as expected, males have higher mean Pb levels. It also appears that females have higher Mn levels. Are these differences significant? Let's conduct t tests.

```{r t tests, eval=FALSE, include=FALSE}

## svyttest: t tests

# Lead (Pb)
####################################

# To determine if this difference is statistically significant, I do a t-test because I am comparing the mean of a continuous variable across two groups 
tt_pb <-
  svyttest(lbxbpb~sex,
           nhanes.svy)

tt_pb

## What if I want a 90% CI instead of a 95% CI? 
# confint(tt, level=0.8)

# Manganese (Mn)
####################################

tt_mn <-
  svyttest(lbxbmn~sex,
           nhanes.svy)

tt_mn

# Cadmium (Cd)
####################################
tt_cd <-
  svyttest(lbxbcd~sex,
           nhanes.svy)

tt_cd

```

The design-based t-tests indicate that the difference in lead, manganese, and cadmium levels across males and females is significant. 

## Differences across age groups

The exposures and body burdens of these various metals often change over the life course, from childhood through elderly years. Do sex differences exist at certain windows across the life course that are otherwise masked when looking at mean metal levels averaged across all ages? 

To explore this, we will create a new categorical variable, "life_stage," that indicates whether an individual is in his or her child, adolescent, adult, or senior years. 

**Question:** Accounting for survey design, what are the mean blood metal levels of 2015/2016 US males and females across childhood, adolescence, adulthood, and senior years? 

We define "child" as age < 12 years,
"adolescent" as age 12-21 years,
"adult" as age 22-65 years, 
and "elderly" as age > 65 years.

```{r differences across life stages, eval=FALSE, include=FALSE}

## create new life stage variable
nh1516_sub <-
  nh1516_sub %>% 
  mutate(life_stage =
           ifelse(age < 12, "Child",
           ifelse(age %in% 12:21, "Adolescent",
           ifelse(age %in% 22:65, "Adult",
                  "Elderly")))) %>% 
  mutate(life_stage = as.factor(life_stage))

# relevel the factors to be in chronological order of life stages
nh1516_sub$life_stage <- fct_relevel(nh1516_sub$life_stage, c("Child", "Adolescent", "Adult", "Elderly"))
  
# Re-set the survey design
# NOTE: We always have to re-set the survey design after we create any new variable.
nhanes.svy <- svydesign(ids = ~sdmvpsu,
                        strata = ~sdmvstra,
                        weights = ~wtsh2yr,
                        nest = TRUE,
                        data = nh1516_sub)

## Calculate means across sex and life stages
svyby(~lbxbpb+lbxbcd+lbxthg+lbxihg+lbxohg+lbxbmn, # continuous variable
      by = ~sex+life_stage, # groups
      nhanes.svy, # the ”svydesign” object 
      svymean)  # the function you want 

life_means_table <- 
  svyby(~lbxbpb+lbxbcd+lbxthg+lbxihg+lbxohg+lbxbmn, 
      by = ~sex+life_stage, 
      nhanes.svy, 
      svymean) %>%  
  kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = F) 

```

Across sex and age groups: 

* print life means data table 

Are these differences seen across sex and age group significant? 

```{r}
# use ANOVA because I am comparing the mean of a continuous variable across two categorical variables (sex and age group)
## or, why categorize it, but first see if it is significant by sex and age, then categorize age to make graphing easier

```

```{r boxplots from original data, eval=FALSE, include=FALSE}

# for Pb
nh1516_sub %>% 
  ggplot(aes(x = sex,
             y = lbxbpb)) +
  geom_boxplot()

## boxplot doesn't look good because there are too many outliers,
## probably because NHANES oversamples specific populations, so the original data are going to be non-representative/biased. go with the survey weighted means

```


```{r graph these means for sex and age group, Pb, eval=FALSE, include=FALSE}

# first, create a new dataset from the life_means_table data
# (did manually by copying and pasting the data into a csv) - can I do this from the original data?? 
# import data
life_means_data <-
  read_csv("life_means.csv") %>% 
  mutate(life_stage = as.factor(life_stage))

life_means_data$life_stage <-
  factor(life_means_data$life_stage, levels = c("Child", "Adolescent", "Adult", "Elderly"))

# Lead
pb_plot <-
life_means_data %>% 
  na.omit() %>% 
  ggplot(aes(x = life_stage, 
             y = Pb,  # change for different metals
             fill = Sex)) +
  geom_col(position = "dodge") +
  geom_errorbar(aes(ymin = Pb - se.lbxbpb, # change for different metalas
                    ymax = Pb + se.lbxbpb),
                    width = 0.2,
                    position = position_dodge(0.9)) +
  labs(title="Levels of Blood Pb in Males vs Females Across Life Stages", # edit labels for diff graphs
       x = "Life Stage",
       y = "Average Blood Pb (ug/dL)",
       caption = "NHANES 2015/2016 data") 

# Lead, Ages 1-2
################################################################

## How can I calculate and graph the mean if the stratum has only one PSU at stage 1??
## lead in ages 1-2
nh1516_young <-
  nh1516_sub %>% 
  filter(age == 1 | age == 2)

nhanes.svy.young <- svydesign(ids = ~sdmvpsu, # cluster IDs
                        strata = ~sdmvstra, # strata IDs
                        weights = ~wtsh2yr, # individual weights, subsample descriptions and weights are found in the specific datafiles downloaded from NHANES website
                        nest = TRUE,
                        data = nh1516_young) # call the dataframe 

svyby(~lbxbpb, # continuous variable
      by = ~sex, # groups
      nhanes.svy.young, # the ”svydesign” object 
      svymean)  # the function you want %>% 

tt_pb_young <-
  svyttest(lbxbpb~sex,
           nhanes.svy.young)

tt_pb_young

nh1516_young %>% 
  na.omit() %>% 
  ggplot(aes(x = age,  
             y = lbxbpb,  # change for different metals
             fill = sex))
## get this to work 

```

```{r graphs for other metals, evaL=FALSE, include=FALSE}

# # Cadmium
# cd_plot <-
# life_means_data %>% 
#   na.omit() %>% 
#   ggplot(aes(x = life_stage, 
#              y = Cd,
#              fill = Sex)) +
#   geom_col(position = "dodge") +
#   geom_errorbar(aes(ymin = Cd - se.lbxbcd,
#                     ymax = Cd + se.lbxbcd),
#                 width = 0.2,
#                 position = position_dodge(0.9)) +
#   labs(title="Levels of Blood Cd in Males vs Females Across Life Stages",
#        x = "Life Stage",
#        y = "Average Blood Cd (ug/L)",
#        caption = "NHANES 2015/2016 data") 
# 
# # Manganese
# mn_plot <-
# life_means_data %>% 
#   na.omit() %>% 
#   ggplot(aes(x = life_stage, 
#              y = Mn,  # change for different metals
#              fill = Sex)) +
#   geom_col(position = "dodge") +
#   geom_errorbar(aes(ymin = Mn - se.lbxbmn, # change for different metalas
#                     ymax = Mn + se.lbxbmn),
#                 width = 0.2,
#                 position = position_dodge(0.9)) +
#   labs(title="Levels of Blood Mn in Males vs Females Across Life Stages", # edit labels for diff graphs
#        x = "Life Stage",
#        y = "Average Blood Mn (ug/L)",
#        caption = "NHANES 2015/2016 data") 
#   
# # Mercury
# # mercury data manipulation
# hg_data <- 
#   life_means_data %>% 
#   mutate("total" = `Total Hg`,
#          "inorganic" = `Inorganic Hg`,
#          "organic" = `Organic Hg`) %>% 
#   select(-Pb, -Cd, -Mn, -se.lbxbpb, -se.lbxbcd, -se.lbxbmn) %>% 
#   pivot_longer(inorganic:organic,
#                names_to = "type",
#                values_to = "value")
# 
# #m_mean = ddply(hg_data, "Sex", summarize, var1 = mean(var1), var2 = mean(var2), var3 = mean(var3))
# #m_devs = ddply(hg_data, "Sex", summarize, var1 = sd(var1), var2 = sd(var2), var3 = sd(var3))
# 
# # plot
# hg_plot <-
#   hg_data %>% 
#   na.omit() %>% 
#   ggplot(aes(x = Sex,
#              y = value,
#              fill = type)) +
#   geom_col() +
#   facet_grid(. ~life_stage) +
#   labs(title = "Levels of Blood Hg in Males vs Females Across Life Stages", # edit labels for diff graphs
#        y = "Average Blood Hg (ug/L)",
#        caption = "NHANES 2015/2016 data") + 
#   scale_fill_discrete(name = "Mercury Type")

## how to add error bars here?????

```


r (print(pb_plot))

r (print(cd_plot))

r (print(mn_plot))

r (print(hg_plot))



```{r urine mercury statistics and graphing, eval=FALSE, include=FALSE}

## svymean: Computes means and SEs for survey data
svymean(~urxuhg, # continuous variable(s)
        uhg.svy) # the ”svydesign” object

# put results into a table
urinary_hg_table <-
  svymean(~urxuhg, nhanes.svy) %>% 
  kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = F) 

##############################################################
## By Sex

## svyby: Survey stats on subsets of data (or, survey stats across levels of factors)
svyby(~urxuhg, # continuous variable
      by = ~sex, # groups
      uhg.svy, # the ”svydesign” object 
      svymean)  # the function you want %>% 

# put into a table
sex_urxhg_table <-
  svyby(~urxuhg, # continuous variable
      by = ~sex, # groups
      uhg.svy, # the ”svydesign” object 
      svymean) %>%  # the function you want %>% 
  kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = F) 

##############################################################
# T Test

## Is the difference across males and females significant?? 
### Should I be doing t tests on log-transformed data if that is more normal? 
svyhist(~urxuhg,
        uhg.svy,
        main = "Survey weighted average urine Hg", col = "blue")

# log transformed
svyhist(~log(urxuhg),
        uhg.svy,
        main = "Survey weighted log(average urine Hg)", col = "blue")
## Still not very normal... 

tt_uhg <-
  svyttest(urxuhg~sex,
           uhg.svy)

tt_uhg

# the difference here is significant but it was done on a non-normal distribution 

```

Mean and Standard Deviation of Urinary (Elemental/Inorganic) Hg: 
r (print(urinary_hg_table))

Broken down by sex: 
r (print(sex_urxhg_table))

Lastly, we will examine urinary arsenic (combining species into organic and inorganic): 

```{r download arsenic data and clean, eval=FALSE, include=FALSE}

# Merge data to create one dataframe per year/NHANES cycle
arsenic_1516 <- merge(uas_sp, uas_t, by = c("SEQN", "WTSA2YR"), all = TRUE)
arsenic_1516 <- merge(arsenic_1516, demo1516, by = "SEQN", all = TRUE)

# Retain only necessary variables:
# uhg_1516 <-
#   uhg_1516 %>%
#   select(SEQN, SDDSRVYR, # unique identifier and survey year 
#          RIAGENDR, RIDAGEYR, RIDRETH1, # gender, age, race/ethnicity
#          WTMEC2YR, SDMVPSU, SDMVSTRA, WTSA2YR, # weighting info, NOTICE IT'S DIFFERENT NOW 
#          URXUHG) # urine mercury
 
head(arsenic_1516)

# clean / rename variable names
arsenic_1516 <-
  arsenic_1516 %>%
  janitor::clean_names() %>% 
  rename(sex = riagendr,
         age = ridageyr,
         race = ridreth1) %>% 
  set_value_labels(
    sex = c("Male" = 1, "Female" = 2), 
    race = c("Mexican American" = 1, "Other Hispanic" = 2, "NH White" = 3, "NH Black" = 4, "Other including multi" = 5)) %>% 
  mutate_if(is.labelled, to_factor) %>% 
  drop_na(wtsa2yr, urxuas)

glimpse(arsenic_1516)

```

```{r arsenic descriptive stats, eval=FALSE, include=FALSE}

## svyby: Survey stats on subsets of data (or, survey stats across levels of factors)
svyby(~urxuas, # continuous variable
      by = ~sex, # groups
      arsenic.svy, # the ”svydesign” object 
      svymean)  # the function you want 

```

```{r urinary arsenic graphs, eval=FALSE, include=FALSE}

# first, some data manipulation
# combine species into inorganic species and organic species


```


```{r chi squared test, eval=FALSE, include=FALSE}

# EXAMPLE CODE for chi-squared test
# Hypertension variable does not exist in our nh1516_sub dataframe

# We are comparing a binary variable (hypertension status) across a categorical variable, so let's use a chi-squared test. We can get the raw numbers from a simple table.
nhanes.svy <-
  svydesign(ids = ~sdmvpsu, 
            strata = ~sdmvstra,  
            weights = ~wtsh2yr, 
            nest = TRUE,
            data = nh1516_sub) #Re-setting the svydesign!

# Contingency table and chi-squared tests for survey data using svychisq
table(nh1516_sub$htn,
      nh1516_sub$race)

svychisq(~htn+sex,
         nhanes.svy,
         statistic="adjWald")

```




