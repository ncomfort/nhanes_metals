---
title: "nhanes_metals"
author: "Nicole Comfort"
date: "11/26/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# install necessary packages
install.packages("tidyverse")
install.packages("NHANES")
install.packages("survey") # Documentation for this package is: https://cran.r-project.org/web/packages/survey/survey.pdf
install.packages("Hmisc")
install.packages("foreign")
install.packages("labelled")

# load libraries
library(tidyverse)
library(NHANES)
library(survey) # This package handles survey weights/designs easily
library(Hmisc) # This is a package (H misc.) for basic desciptive functions.
library(foreign) # This package allows us to open .XPT files
library(labelled)

```

# Background:  
The National Health and Nutrition Examination Survey (NHANES) is a nationally-representative survey of the general, noninstutionalized US population conducted by the National Center for Health Statistics. NHANES is a multi-stage, nationally representative sample in two-year cycles; participants are chosen to represent the entire general US. Certain age groups and racial/ethnic groups are intentionally oversampled to ensure adequate power to analyze these populations.

Participants undergo thorough examination including demographic questionnaire, a 24-hr dietary recall, a clinical examination, and a laboratory examination. All NHANES protocols were approved by the National Center for Health Statistics institutional review board, and all participants gave written informed consent.

For more information on NHANES, view the Centers for Disease Control and Prevention (CDC) website: https://www.cdc.gov/nchs/nhanes/index.htm

### Note:
NHANES does not measure every environmental chemical in every participant. For some environmental chemicals, these measurements are only done on a subset of participant samples and there are special sub-weights that need to be used for analyzing these chemicals. As a general rule, you should use the weight for the smallest of the sampling subset you are analyzing in NHANES. 

Here, we will explore the levels of lead, cadmium, mercury, and manganese measured in blood of males versus females to examine if there is a sex difference in body burden of these chemicals.

We will conduct this analysis in one two-year survey cycle (2015/2016) to start.

## Download NHANES Data and Clean

The data files must first be downloaded. They can be found and downloaded at the NHANES website: https://wwwn.cdc.gov/nchs/nhanes/continuousnhanes/default.aspx?BeginYear=2015 

They must first be downloaded.

```{r NHANES metal data}
# Load data

# Demographic files for 2015-2016
demo1516 <- read.xport("DEMO_I.XPT")
# Laboratory blood Pb, Cd, Hg, Mn files for 2015-2016
cd1516 <- read.xport("PBCD_I.XPT")
# Inorganic, Ethyl, Methyl Mercury for 2015-2016
hg1516 <- read.xport("IHGEM_I.XPT")

# Merge data to create one dataframe per year; then keep only the necessary variables:
nh1516 <- merge(demo1516, cd1516, by = "SEQN", all = T)
nh1516 <- merge(nh1516, hg1516, by = c("SEQN", "WTSH2YR"), all = T) # can I do the analysis without the WTSH2YR?? If not, I will have to exclude those who have this value as "NA"

# double check that there aren't repeat columns renamed [col_name].x or [col_name].y


# Here is a list of variables we will need for our analysis:
# SEQN, SDDSRVYR, RIAGENDR, RIDAGEYR, RIDRETH1, WTMEC2YR, SDMVPSU, SDMVSTRA, WTSH2YR
# LBXBPB, LBXBCD, LBXTHG, LBXIHG, LBXBSE, LBXBMN

## any more?  (11/26/19 7:17pm)

# Retain only necessary variables:
nh1516_sub <- nh1516 %>%
  select(SEQN, SDDSRVYR, # unique identifier and ? 
         RIAGENDR, RIDAGEYR, RIDRETH1, # gender, age, race/ethnicity
         WTMEC2YR, SDMVPSU, SDMVSTRA, WTSH2YR, # weighting info
         LBXBPB, LBXBCD, LBXTHG, LBXIHG, LBXBSE, LBXBMN) # metals

head(nh1516_sub)

```

```{r}
## NOTE: the correct weights to use for this analysis of urinary arsenic data are WTSA2YR

nh1112_sub <- nh1112_sub%>%
  rename(gender = RIAGENDR, age = RIDAGEYR, race=RIDRETH1, totalarsenic = URXUAS, sbp1 = BPXSY1, sbp2 = BPXSY2, sbp3 = BPXSY3)  

glimpse(nh1112_sub)

# Label variable values
nh1112_sub <- nh1112_sub %>%
  set_value_labels(
    gender = c("Male" = 1, "Female" = 2), 
    race = c("Mexican American" = 1, "Other Hispanic" = 2, "NH White" = 3, "NH Black" = 4, "Other including multi" = 5))

glimpse(nh1112_sub)

# Treat any labelled variables as factors
nh1112_sub <- nh1112_sub %>%
  mutate_if(is.labelled, to_factor)

```


## Sample Weighting

You can also embed plots, for example:

```{r pressure, echo=FALSE}

# Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

plot(pressure)

```

## Descriptive Statistics

```{r}

```

## Data Visualization

```{r}

```



