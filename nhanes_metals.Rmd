---
title: "nhanes_metals"
author: "Nicole Comfort"
date: "11/26/2019"
output: html_document
---

First, check whether you have the necessary packages installed and if not, install them.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

##  install necessary packages

#install.packages("tidyverse")
#install.packages("NHANES")
#install.packages("survey") # Used to take into account complex survey designs like NHANES
## Documentation for this package is: https://cran.r-project.org/web/packages/survey/survey.pdf

# install.packages("Hmisc")
# install.packages("foreign")
# install.packages("labelled")
# install.packages("knitr")
# install.packages("kableExtra")

# load libraries
library(tidyverse)
library(NHANES)
library(survey) # This package handles survey weights/designs easily
library(Hmisc) # This is a package (H misc.) for basic desciptive functions.
library(foreign) # This package allows us to open .XPT files
library(labelled)
library(knitr)
library(kableExtra)

```

# Background:  
The National Health and Nutrition Examination Survey (NHANES) is a nationally-representative survey of the general, noninstutionalized US civilian population conducted by the National Center for Health Statistics. NHANES is a multi-stage, nationally representative sample in two-year cycles; participants are chosen to represent the entire general US. Certain age groups and racial/ethnic groups are intentionally oversampled to ensure adequate power to analyze these populations.

Participants undergo thorough examination including demographic questionnaire, a 24-hr dietary recall, a clinical examination, and a laboratory examination. All NHANES protocols were approved by the National Center for Health Statistics institutional review board, and all participants gave written informed consent.

For more information on NHANES, view the Centers for Disease Control and Prevention (CDC) website: https://www.cdc.gov/nchs/nhanes/index.htm

### Note:
NHANES does not measure every environmental chemical in every participant. For some environmental chemicals, these measurements are only done on a subset of participant samples and there are special sub-weights that need to be used for analyzing these chemicals. As a general rule, you should use the weight for the smallest of the sampling subset you are analyzing in NHANES.

Here, we will explore the levels of lead, cadmium, mercury, and manganese measured in blood of males versus females to examine if there is a sex difference in body burden of these chemicals.

We will conduct this analysis in one two-year survey cycle (2015/2016) to start, *since combining weights across survey cycles is very complex.* See http://www.cdc.gov/nchs/tutorials/NHANES/SurveyDesign/Weighting/intro.htm for more information. 

## Download NHANES Data and Clean

The data files must first be downloaded. They can be found and downloaded at the NHANES website: https://wwwn.cdc.gov/nchs/nhanes/continuousnhanes/default.aspx?BeginYear=2015 

They must first be downloaded.

```{r NHANES metal data}
# Load data

# Demographic files for 2015-2016
demo1516 <- read.xport("DEMO_I.XPT")
## Data documentation file: https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/DEMO_I.htm

# Laboratory blood Pb, Cd, Hg, Mn files for 2015-2016
cd1516 <- read.xport("PBCD_I.XPT")
## Data documentation file: https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/PBCD_I.htm
### Eligible Sample: All examined participants aged 1-11 years old, and a one-half sample from participants aged 12 years and older were eligible.

# Inorganic, Ethyl, Methyl Mercury for 2015-2016
hg1516 <- read.xport("IHGEM_I.XPT")
## Data documentation file: https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/IHGEM_I.htm
### Eligible Sample: All examined participants aged 1-11 years old, and a one-half sample from participants aged 12 years and older were eligible.

```

```{r create dataframe}

# Merge data to create one dataframe per year; then keep only the necessary variables:
nh1516 <- merge(demo1516, cd1516, by = "SEQN", all = TRUE)
nh1516 <- merge(nh1516, hg1516, by = c("SEQN", "WTSH2YR"), all = TRUE) # exclude those who have this value as "NA"

# double check that there aren't repeat columns renamed [col_name].x or [col_name].y

## Here is a list of variables we will need for our analysis:
# SEQN, SDDSRVYR, RIAGENDR, RIDAGEYR, RIDRETH1, WTMEC2YR, SDMVPSU, SDMVSTRA, WTSH2YR
# LBXBPB (blood lead), LBXBCD (blood cadmium),
# LBXTHG (blood total mercury), LBXIHG (blood inorganic mercury),
# LBXBSE (blood selenium), LBXBMN (blood manganese)

## any more?  (11/26/19 7:17pm)

# Retain only necessary variables:
nh1516_sub <-
  nh1516 %>%
  select(SEQN, SDDSRVYR, # unique identifier and ? 
         RIAGENDR, RIDAGEYR, RIDRETH1, # gender, age, race/ethnicity
         WTMEC2YR, SDMVPSU, SDMVSTRA, WTSH2YR, # weighting info
         LBXBPB, LBXBCD, LBXTHG, LBXIHG, LBXBMN) # metals (exclude selenium for now)

head(nh1516_sub)

# clean / rename variable names
nh1516_sub <-
  nh1516_sub %>%
  janitor::clean_names() %>% 
  rename(sex = riagendr,
         age = ridageyr,
         race = ridreth1) %>% 
  mutate(lbxohg = lbxthg - lbxihg) # create new variable for organic mercury (total Hg - inorganic Hg)
# why are some organic mercury values negative?? 

glimpse(nh1516_sub)

# Label variable values
nh1516_sub <-
  nh1516_sub %>%
  set_value_labels(
    sex = c("Male" = 1, "Female" = 2), 
    race = c("Mexican American" = 1, "Other Hispanic" = 2, "NH White" = 3, "NH Black" = 4, "Other including multi" = 5))

glimpse(nh1516_sub)

# Treat any labelled variables (e.g. sex) as factors
nh1516_sub <-
  nh1516_sub %>%
  mutate_if(is.labelled, to_factor)

```

Let's evaluate the missing data. Blood metals are measured in all participants aged 1-11 years old, and additionally in only a one-half subsample of participants 12 years and older. Let's find how many people are missing our main variables of interest: blood lead, cadmium, total and inorganic mercury, and manganese.

```{r remove NAs}

# assess missingness
# for Pb
nh1516_sub %>%
  count(is.na(lbxbpb))

# for Cd
nh1516_sub %>%
  count(is.na(lbxbcd))
 
# for total Hg 
nh1516_sub %>%
  count(is.na(lbxthg))

# for inorganic Hg
nh1516_sub %>%
  count(is.na(lbxihg))

# for Mn
nh1516_sub %>%
  count(is.na(lbxbmn))

# remove those with NAs

## should I create a separate dataset for each?? or only retain those that are COMPLETE CASES?? (Ask Annie)
# for now (11/27/19 10:30am), I will retain only complete cases

# drop rows with missing values
nh1516_sub <-
  nh1516_sub %>% 
  drop_na()

```

After retaining only complete cases with no missing values, we are left with `r print(nrow(nh1516_sub))` observations. 

## Sample Weighting

Note that NHANES is designed to sample larger numbers of certain subgroups of particular public health interest (e.g. low income Americans, African Americans). Oversampling is done to increase the reliability and precision of estimates of health status indicators for these population subgroups. To account for this sampling design and these design features in our analysis, it is critical that we apply sample weights.

Continue data cleaning by applying appropriate sample weights: 

```{r sample weighting}

### NOTE: the correct weights to use for this analysis of blood metal data are.... WTSH2YR (double check)

## from NHANES: 

########################################################################
# The appropriate sample weights are provided in the variable WTSH2YR in this data file for all participants and should be used when analyzing these data.

# The analytes included in this dataset were measured for all examined participants aged 1-11 years, and in a one-half subsample of participants 12 years and older. For participants aged 1-11 years their WTSH2YR are equivalent to their MEC exam sample weights. These 1-11 years old participants have completed at least one physical exam component in the MEC; therefore, they all have an exam sample weight larger than “0,” regardless of their lab test results.

# For participants 12 years and older, special sample weights were created for the subsample. These special weights accounted for the additional probability of selection into the subsample, as well as the additional nonresponse to these lab tests. Therefore, if a participant 12 years and older was selected as part of the one-half subsample, but did not provide a blood specimen, he/she would have the sample weight value assigned as “0” in his/her record. 
########################################################################
  
# you have to choose the survey weights that correspond to the smallest subsample that is relevant for each metal/survey year of interest
# I think that these metals (Pb, Cd, Hg, Mn) were measured in everybody, check teh data documentation and double-check with Annie


```

## Survey Weights

```{r survey weighting, echo=FALSE}

# Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
# Primary Sampling Units (PSU)

# Here we use "svydesign" to assign the weights. We will use this new survey design variable when running our analyses
nhanes.svy <- svydesign(ids = ~sdmvpsu, # cluster IDs
                        strata = ~sdmvstra, # strata IDs
                        weights = ~wtsh2yr, # individual weights, subsample descriptions and weights are found in the specific datafiles downloaded from NHANES website
                        nest = TRUE,
                        data = nh1516_sub) # call the dataframe 

summary(nhanes.svy)

# account for non-response (since there are many sub-components of NHANES, incl. interview, labs, exposure data)
# thus, sub-samples have different weights because not all participants are invited to participate in all sub-components


## If you want to combine weights across sub-samples within a survey cycle or across survey cycles, this is even more complex
## Advice: don’t do it unless you understand what you are doing.  



```

## Descriptive Statistics

Find the mean levels and SE of Pb, Cd, Hg (inorganic and organic), and Mn in the US population (accounting for survey weights and design). 

```{r descriptive stats using survey functions}

# useful survey functions: 

## svymean: Computes means and SEs for survey data
svymean(~lbxbpb, # continuous variable(s)
        nhanes.svy) # the ”svydesign” object

# Example, we compute the means of multiple variables:
svymean(~lbxbpb+lbxbcd+lbxthg+lbxihg+lbxohg+lbxbmn, 
        nhanes.svy)

# put results into a table
mean_metals_table <-
  svymean(~lbxbpb+lbxbcd+lbxthg+lbxihg+lbxohg+lbxbmn, nhanes.svy) %>% 
  kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = F) 
# note that lbxbpb is in the units ug/dL whereas the others are in ug/L

##############################################################
## By Sex

## svyby: Survey stats on subsets of data (or, survey stats across levels of factors)
svyby(~lbxbpb+lbxbcd+lbxthg+lbxihg+lbxohg+lbxbmn, # continuous variable
      by = ~sex, # groups
      nhanes.svy, # the ”svydesign” object 
      svymean)  # the function you want %>% 

# put into a table
sex_mean_metals_table <-
  svyby(~lbxbpb+lbxbcd+lbxthg+lbxihg+lbxohg+lbxbmn, # continuous variable
      by = ~sex, # groups
      nhanes.svy, # the ”svydesign” object 
      svymean) %>%  # the function you want %>% 
  kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = F) 

##############################################################

# Other useful functions: 

## svyhist: Survey-weighted histograms

## svyquantile: Computes quantiles for survey data (you can choose the quantile values)
svyquantile(~lbxbpb, # continuous variable 
            nhanes.svy, # the ”svydesign” object 
            c(0.10, 0.90), # list of percentiles
            ci = F)

## svychisq: Contingency table and chi-squared tests for survey data; weighted cross tabulations

```


The following are the estimated means and SEs of blood levels of lead, cadmium, mercury (total, inorganic, and organic), and manganese in the US population: 

`r (print(mean_metals_table))`

Broken down by sex: 

`r (print(sex_mean_metals_table))`

```{r t tests}

## svyttest: t tests

```


## Data Visualization

```{r}

```



